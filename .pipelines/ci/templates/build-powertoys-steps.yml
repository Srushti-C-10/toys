parameters:
  additionalBuildArguments: ''

steps:
- checkout: self
  fetchDepth: 1
  submodules: true
  clean: true

- task: UseDotNet@2
  displayName: 'Use .NET 7 SDK'
  inputs:
    packageType: sdk
    version: '7.x'

- task: NuGetToolInstaller@1
  displayName: Ensure NuGet Installer

- task: VisualStudioTestPlatformInstaller@1
  displayName: Ensure VSTest Platform

- task: NuGetCommand@2
  displayName: Restore NuGet packages for PowerToys.sln
  inputs:
    command: restore
    feedsToUse: config
    configPath: NuGet.config
    restoreSolution: PowerToys.sln
    restoreDirectory: '$(Build.SourcesDirectory)\packages'

- task: VSBuild@1
  displayName: 'Build PowerToys.sln'
  inputs:
    solution: '**\PowerToys.sln'
    vsVersion: 17.0
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    msbuildArgs: ${{ parameters.additionalBuildArguments }}
    maximumCpuCount: true

# Native dlls
- task: VSTest@2
  condition: ne(variables['BuildPlatform'],'arm64') # No arm64 agents to run the tests.
  displayName: 'Native Tests'
  inputs:
    platform: '$(BuildPlatform)'
    configuration: '$(BuildConfiguration)'
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\UnitTests-CommonLib.dll
      **\UnitTests-FancyZones.dll
      !**\obj\**

- task: PowerShell@2
  displayName: Trigger dotnet welcome message so that it does not cause errors on other scripts
  inputs:
    targetType: 'inline'
    script: |
      dotnet list $(build.sourcesdirectory)\src\common\Common.UI\Common.UI.csproj package

- task: PowerShell@2
  displayName: Verifying Notice.md and Nuget packages match
  inputs:
    filePath: '$(build.sourcesdirectory)\.pipelines\verifyNoticeMdAgainstNugetPackages.ps1'
    arguments: -path '$(build.sourcesdirectory)\'
    pwsh: true
